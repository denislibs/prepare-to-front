# Как работает «сборщик мусора» в JavaScript?

Сборщик мусора (Garbage Collector, GC) — это автоматический механизм управления памятью в JavaScript, который освобождает память, занятую объектами, которые больше не используются. Понимание работы сборщика мусора критически важно для написания эффективного кода и избежания утечек памяти.

## Что такое сборщик мусора?

Сборщик мусора — это автоматический механизм, который отслеживает использование памяти и освобождает память, занятую объектами, которые больше не доступны в программе.

### Характеристики:

- ✅ **Автоматический** — работает без вмешательства программиста
- ✅ **Непрерывный** — работает в фоновом режиме
- ✅ **Умный** — определяет неиспользуемые объекты
- ✅ **Оптимизированный** — минимизирует паузы выполнения

## Как работает сборщик мусора

### 1. **Маркировка (Mark and Sweep)**

Самый распространенный алгоритм сборки мусора.

```javascript
// Объект становится недоступным
let obj = { name: "John" };
obj = null; // Объект помечен для удаления

// Сборщик мусора удалит объект в следующий цикл
```

### 2. **Достижимость (Reachability)**

Объект считается достижимым, если на него есть ссылка из корня (глобального объекта).

```javascript
// Достижимый объект
let user = { name: "John" };
// user ссылается на объект, объект достижим

// Недостижимый объект
user = null;
// Нет ссылок на объект, объект недостижим и будет удален
```

### 3. **Циклические ссылки**

Сборщик мусора может обрабатывать циклические ссылки.

```javascript
// Циклическая ссылка
let obj1 = { name: "John" };
let obj2 = { ref: obj1 };
obj1.ref = obj2;

// Если оба объекта недостижимы, оба будут удалены
obj1 = null;
obj2 = null;
```

## Алгоритмы сборки мусора

### 1. **Mark and Sweep**

```javascript
// Фаза 1: Маркировка - помечает все достижимые объекты
// Фаза 2: Очистка - удаляет все немаркированные объекты

let obj = { data: "value" };
obj = null; // Объект будет помечен и удален
```

### 2. **Generational Collection**

```javascript
// Разделение объектов на поколения
// Молодые объекты проверяются чаще
// Старые объекты проверяются реже

let newObj = { data: "new" }; // Молодой объект
let oldObj = { data: "old" }; // Старый объект (после нескольких циклов)
```

### 3. **Incremental Collection**

```javascript
// Постепенная сборка мусора
// Разбивает работу на небольшие части
// Минимизирует паузы выполнения
```

## Практические примеры

### Пример 1: Простое удаление

```javascript
// Создание объекта
let user = {
  name: "John",
  age: 30
};

// Объект достижим
console.log(user.name); // "John"

// Удаление ссылки
user = null;

// Объект недостижим, будет удален сборщиком мусора
```

### Пример 2: Массивы

```javascript
// Создание массива
let items = [1, 2, 3, 4, 5];

// Массив достижим
console.log(items.length); // 5

// Удаление ссылки
items = null;

// Массив недостижим, будет удален
```

### Пример 3: Замыкания

```javascript
// Замыкание сохраняет ссылку
function createCounter() {
  let count = 0;
  return function() {
    return ++count;
  };
}

let counter = createCounter();
counter(); // 1
counter(); // 2

// Если counter = null, замыкание все еще может быть достижимо
// если есть другие ссылки
```

### Пример 4: Event Listeners

```javascript
// Event listener сохраняет ссылку
function setupListener() {
  const button = document.getElementById("btn");
  button.addEventListener("click", function() {
    console.log("Clicked");
  });
}

// Если button удален из DOM, но listener не удален,
// объект может остаться в памяти
```

## Оптимизация сборки мусора

### 1. **Удаление ссылок**

```javascript
// ✅ Хорошо - явное удаление ссылок
let data = largeArray;
// Использование данных
data = null; // Освобождение памяти
```

### 2. **Очистка массивов**

```javascript
// ✅ Хорошо - очистка массива
let items = [1, 2, 3, 4, 5];
items.length = 0; // Очистка массива
```

### 3. **Удаление event listeners**

```javascript
// ✅ Хорошо - удаление listeners
function cleanup() {
  button.removeEventListener("click", handler);
}
```

## Когда происходит сборка мусора

### 1. **Автоматически**

```javascript
// Сборщик мусора работает автоматически
// Когда память заполняется или по расписанию
```

### 2. **Принудительно (не рекомендуется)**

```javascript
// В некоторых движках можно вызвать принудительно
// Но это не рекомендуется и не стандартизировано
if (global.gc) {
  global.gc();
}
```

## Лучшие практики

### ✅ Делайте:

1. **Удаляйте ссылки** — когда объекты больше не нужны
2. **Очищайте массивы** — устанавливайте length = 0
3. **Удаляйте listeners** — при уничтожении компонентов
4. **Используйте WeakMap/WeakSet** — для слабых ссылок

### ❌ Не делайте:

1. **Не создавайте циклические ссылки** — без необходимости
2. **Не храните большие данные** — без необходимости
3. **Не забывайте очищать** — временные структуры данных
4. **Не полагайтесь на GC** — для критической производительности

## Заключение

Сборщик мусора:

- **Автоматический механизм** — управления памятью
- **Маркировка и очистка** — основные алгоритмы
- **Достижимость** — критерий для удаления объектов
- **Оптимизация** — минимизация пауз выполнения

**Помните:** сборщик мусора автоматически управляет памятью в JavaScript. Понимание его работы помогает писать эффективный код и избегать утечек памяти. Используйте лучшие практики для оптимизации использования памяти и не полагайтесь на сборщик мусора для критической производительности.


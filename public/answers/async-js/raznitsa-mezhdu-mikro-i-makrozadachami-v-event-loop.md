# Разница между микро и макрозадачами в event loop?

Понимание разницы между микрозадачами (microtasks) и макрозадачами (macrotasks) в Event Loop критически важно для правильного понимания порядка выполнения асинхронного кода в JavaScript. Эти два типа задач имеют разные приоритеты выполнения и обрабатываются Event Loop по-разному. Знание этих различий помогает предсказывать порядок выполнения кода и избегать неожиданного поведения.

## Что такое макрозадачи (Macrotasks)?

Макрозадачи — это задачи, которые выполняются после завершения текущего выполнения кода и после выполнения всех микрозадач. Макрозадачи обрабатываются по одной за раз.

### Типы макрозадач:

- ✅ **setTimeout** — таймеры
- ✅ **setInterval** — интервалы
- ✅ **setImmediate** — (Node.js)
- ✅ **I/O операции** — чтение файлов, сетевые запросы
- ✅ **События DOM** — клики, загрузка и т.д.
- ✅ **requestAnimationFrame** — анимации

### Характеристики макрозадач:

- ⏱️ **Выполняются по одной** — одна макрозадача за цикл Event Loop
- ⏱️ **После микрозадач** — выполняются после всех микрозадач
- ⏱️ **Могут быть отложены** — браузер может отложить выполнение
- ⏱️ **Низкий приоритет** — относительно микрозадач

### Пример макрозадач:

```javascript
console.log('1');

// Макрозадача 1
setTimeout(() => {
  console.log('2');
}, 0);

// Макрозадача 2
setTimeout(() => {
  console.log('3');
}, 0);

console.log('4');

// Вывод: 1, 4, 2, 3
// Макрозадачи выполняются по одной после синхронного кода
```

## Что такое микрозадачи (Microtasks)?

Микрозадачи — это задачи с высоким приоритетом, которые выполняются сразу после завершения текущего выполнения кода, но ПЕРЕД макрозадачами. Все микрозадачи выполняются до выполнения любой макрозадачи.

### Типы микрозадач:

- ✅ **Promise.then/catch/finally** — обработчики промисов
- ✅ **queueMicrotask()** — явное создание микрозадачи
- ✅ **MutationObserver** — наблюдение за изменениями DOM
- ✅ **process.nextTick** — (Node.js, еще выше приоритет)

### Характеристики микрозадач:

- ⚡ **Выполняются все сразу** — все микрозадачи выполняются до макрозадач
- ⚡ **Высокий приоритет** — выполняются перед макрозадачами
- ⚡ **Немедленное выполнение** — после синхронного кода
- ⚡ **Могут создавать новые микрозадачи** — которые тоже выполняются

### Пример микрозадач:

```javascript
console.log('1');

// Микрозадача 1
Promise.resolve().then(() => {
  console.log('2');
});

// Микрозадача 2
Promise.resolve().then(() => {
  console.log('3');
});

console.log('4');

// Вывод: 1, 4, 2, 3
// Все микрозадачи выполняются сразу после синхронного кода
```

## Ключевые различия

### 1. **Приоритет выполнения**

**Микрозадачи:**
```javascript
console.log('1');

Promise.resolve().then(() => console.log('2'));
setTimeout(() => console.log('3'), 0);

console.log('4');

// Вывод: 1, 4, 2, 3
// Микрозадача (2) выполняется ПЕРЕД макрозадачей (3)
```

**Макрозадачи:**
```javascript
console.log('1');

setTimeout(() => console.log('2'), 0);
setTimeout(() => console.log('3'), 0);

console.log('4');

// Вывод: 1, 4, 2, 3
// Макрозадачи выполняются по одной
```

### 2. **Количество выполняемых задач**

**Микрозадачи:**
```javascript
console.log('1');

Promise.resolve().then(() => console.log('2'));
Promise.resolve().then(() => console.log('3'));
Promise.resolve().then(() => console.log('4'));

setTimeout(() => console.log('5'), 0);

console.log('6');

// Вывод: 1, 6, 2, 3, 4, 5
// ВСЕ микрозадачи (2, 3, 4) выполняются до макрозадачи (5)
```

**Макрозадачи:**
```javascript
console.log('1');

setTimeout(() => console.log('2'), 0);
setTimeout(() => console.log('3'), 0);
setTimeout(() => console.log('4'), 0);

console.log('5');

// Вывод: 1, 5, 2, 3, 4
// Макрозадачи выполняются по одной за цикл Event Loop
```

### 3. **Вложенные задачи**

**Микрозадачи могут создавать новые микрозадачи:**
```javascript
console.log('1');

Promise.resolve().then(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
  });
  console.log('4');
});

setTimeout(() => {
  console.log('5');
}, 0);

console.log('6');

// Вывод: 1, 6, 2, 4, 3, 5
// Все микрозадачи (включая вложенные) выполняются до макрозадач
```

## Порядок выполнения в Event Loop

### Полный цикл:

1. **Выполнение синхронного кода** (Call Stack)
2. **Выполнение ВСЕХ микрозадач** (Microtask Queue)
3. **Выполнение ОДНОЙ макрозадачи** (Callback Queue)
4. **Повторение** с шага 2

### Визуализация:

```
┌─────────────────────┐
│   Call Stack        │ ← Синхронный код
└─────────────────────┘
         ↓
┌─────────────────────┐
│ Microtask Queue     │ ← ВСЕ микрозадачи выполняются
│ (Promise, queueMicrotask) │
└─────────────────────┘
         ↓
┌─────────────────────┐
│ Callback Queue      │ ← ОДНА макрозадача за раз
│ (setTimeout, events)│
└─────────────────────┘
```

## Практические примеры

### Пример 1: Смешанные задачи

```javascript
console.log('Начало');

// Макрозадача
setTimeout(() => {
  console.log('setTimeout 1');
}, 0);

// Микрозадача
Promise.resolve().then(() => {
  console.log('Promise 1');
});

// Макрозадача
setTimeout(() => {
  console.log('setTimeout 2');
}, 0);

// Микрозадача
Promise.resolve().then(() => {
  console.log('Promise 2');
});

console.log('Конец');

// Вывод:
// Начало
// Конец
// Promise 1      ← все микрозадачи
// Promise 2      ← выполняются
// setTimeout 1   ← затем макрозадачи
// setTimeout 2   ← по одной
```

### Пример 2: Вложенные микрозадачи

```javascript
console.log('1');

Promise.resolve().then(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
    Promise.resolve().then(() => {
      console.log('4');
    });
  });
  console.log('5');
});

setTimeout(() => {
  console.log('6');
}, 0);

console.log('7');

// Вывод: 1, 7, 2, 5, 3, 4, 6
// Все микрозадачи (включая вложенные) выполняются до макрозадач
```

### Пример 3: Микрозадачи внутри макрозадач

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
  });
  console.log('4');
}, 0);

Promise.resolve().then(() => {
  console.log('5');
});

console.log('6');

// Вывод: 1, 6, 5, 2, 4, 3
// Порядок:
// 1. Синхронный: 1, 6
// 2. Микрозадачи: 5
// 3. Макрозадача: 2, 4 (синхронный код внутри)
// 4. Микрозадачи из макрозадачи: 3
```

### Пример 4: queueMicrotask

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
}, 0);

queueMicrotask(() => {
  console.log('3');
});

Promise.resolve().then(() => {
  console.log('4');
});

console.log('5');

// Вывод: 1, 5, 3, 4, 2
// queueMicrotask и Promise - оба микрозадачи
// Выполняются в порядке добавления
```

## Сравнительная таблица

| Характеристика | Микрозадачи | Макрозадачи |
|----------------|-------------|-------------|
| **Приоритет** | Высокий | Низкий |
| **Выполнение** | Все сразу | По одной |
| **Когда выполняются** | После синхронного кода, перед макрозадачами | После всех микрозадач |
| **Примеры** | Promise, queueMicrotask | setTimeout, события DOM |
| **Вложенность** | Могут создавать новые микрозадачи | Выполняются по одной |

## Важные нюансы

### 1. **Микрозадачи блокируют макрозадачи**

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
}, 0);

// Много микрозадач
for (let i = 0; i < 1000; i++) {
  Promise.resolve().then(() => {
    // Какая-то работа
  });
}

console.log('3');

// setTimeout выполнится только после ВСЕХ 1000 промисов
// Это может заблокировать UI
```

### 2. **Бесконечные микрозадачи**

```javascript
function infiniteMicrotasks() {
  Promise.resolve().then(() => {
    console.log('Микрозадача');
    infiniteMicrotasks(); // Создает новую микрозадачу
  });
}

infiniteMicrotasks();
// Макрозадачи никогда не выполнятся!
// UI заблокируется
```

## Лучшие практики

### ✅ Делайте:

1. **Используйте микрозадачи** — для критичных операций
2. **Используйте макрозадачи** — для отложенных операций
3. **Избегайте бесконечных микрозадач** — могут заблокировать UI
4. **Понимайте приоритеты** — микрозадачи перед макрозадачами

### ❌ Не делайте:

1. **Не создавайте слишком много микрозадач** — может заблокировать выполнение
2. **Не полагайтесь на порядок макрозадач** — они могут выполняться в разном порядке
3. **Не блокируйте Event Loop** — долгими операциями в микрозадачах

## Заключение

Разница между микро и макрозадачами:

- **Микрозадачи** — высокий приоритет, выполняются все сразу, перед макрозадачами (Promise, queueMicrotask)
- **Макрозадачи** — низкий приоритет, выполняются по одной, после микрозадач (setTimeout, события)

**Помните:** микрозадачи имеют приоритет над макрозадачами и выполняются все сразу после синхронного кода. Макрозадачи выполняются по одной после всех микрозадач. Понимание этого порядка критически важно для предсказуемого асинхронного кода.

